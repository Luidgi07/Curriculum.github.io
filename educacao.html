<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Biblioteca 3D – Livros todos para dentro</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #info { position: absolute; top: 12px; left: 12px;
      background: rgba(255,255,255,0.92); padding: 10px 18px;
      border-radius: 8px; font-family: 'Segoe UI', sans-serif; font-size: 1.1rem;
      color: #0066bb; z-index: 4; }
    #hud { position: fixed; left: 24px; bottom: 24px;
      background: rgba(240,247,255,0.95); padding: 13px 22px 11px 18px;
      border-radius: 14px; font-family: 'Segoe UI'; color: #083c6a;
      min-width: 210px; font-size: 1.1rem; z-index: 10;
      border: 2px solid #a5c7e6;}
    #hud .title { font-weight: bold; font-size: 1.05rem; margin-bottom: 8px; }
    #hud .keys { margin-top: 0; margin-bottom: 0; }
    #hud .key { background: #dbeafe; border-radius: 5px; padding: 3px 8px;
      margin: 0 4px; border: 1px solid #a5c7e6; font-weight: 500;
      display: inline-block; font-size: 1.0rem; color: #2a68b2; }
    #hud .desc { margin-top: 10px; font-size: 0.97rem; color: #1e3d59; }
  </style>
</head>
<body>
  <div id="info">Usa WASD para mover o boneco. Aproxima-te das prateleiras e pressiona <b>O</b> para ver info.</div>
  <div id="hud">
    <div class="title">Comandos:</div>
    <div class="keys">
      <span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span>
      <span class="desc">Mover personagem</span>
    </div>
    <div class="keys" style="margin-top:7px;">
      <span class="key">O</span>
      <span class="desc">Abrir informação próxima</span>
    </div>
  </div>

  <script src="https://unpkg.com/three@0.153.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.153.0/examples/js/loaders/STLLoader.js"></script>
  <script>
    // Setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xe8e3d1);
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 8, 20);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xfad7a0, 0.7));
    const dirLight = new THREE.DirectionalLight(0xffe1b7, 0.85);
    dirLight.position.set(12, 22, 18);
    scene.add(dirLight);

    // Chão
    const chaoGeo = new THREE.BoxGeometry(20, 0.3, 20);
    const chaoMat = new THREE.MeshLambertMaterial({ color: 0xc9ad7c });
    const chao = new THREE.Mesh(chaoGeo, chaoMat);
    chao.position.y = -0.25;
    chao.userData.solido = true;
    scene.add(chao);

    // Estantes e prateleiras (código igual omitido aqui para brevidade - copia do teu código original)
    // ... (Inclui as funções criaEstanteTraseiraLivros, criaEstanteLateralLivros e criaPrat, e as chamadas que definires)

    // Variável para o boneco STL
    let bonecoSTL = null;

    // Loader STL
    const loader = new STLLoader();
    loader.load(
      'modelos/meuBoneco.stl',  // ajusta para o caminho do arquivo STL no teu repositório
      function(geometry) {
        const material = new THREE.MeshStandardMaterial({color: 0x2196f3});
        bonecoSTL = new THREE.Mesh(geometry, material);
        bonecoSTL.position.set(0, 0.25, 6);
        bonecoSTL.scale.set(0.3, 0.3, 0.3);  // ajusta escala conforme necessário
        scene.add(bonecoSTL);
        console.log('STL carregado com sucesso!');
      },
      undefined,
      function(error) {
        console.error('Erro ao carregar STL:', error);
      }
    );

    // Parte reserva: cria boneco em blocos para usar se STL ainda não carregou
    function criaBoneco() {
      const grupo = new THREE.Group();
      const corpoGeo = new THREE.BoxGeometry(1, 1.6, 0.7);
      const corpoMat = new THREE.MeshLambertMaterial({ color: 0x2196f3 });
      const corpo = new THREE.Mesh(corpoGeo, corpoMat); corpo.position.y = 1;
      grupo.add(corpo);
      const cabecaGeo = new THREE.BoxGeometry(0.8, 0.7, 0.7);
      const cabecaMat = new THREE.MeshLambertMaterial({ color: 0xfff176 });
      const cabeca = new THREE.Mesh(cabecaGeo, cabecaMat); cabeca.position.y = 2;
      grupo.add(cabeca);
      grupo.position.set(0, 0.25, 6);
      return grupo;
    }
    let bonecoReserva = criaBoneco();
    scene.add(bonecoReserva);

    // Movimento, colisões e interação - idênticos ao código original
    const keys = {};
    document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    let prateleiraPerto = null;
    const speed = 0.13;

    const objetosSolidos = [];
    function atualizaColisoes() {
      objetosSolidos.length = 0;
      scene.traverse(obj => { if (obj.userData && obj.userData.solido) objetosSolidos.push(obj); });
    }
    atualizaColisoes();

    function colisao(nx, ny, nz) {
      for (const obj of objetosSolidos) {
        const ox = obj.position.x, oy = obj.position.y, oz = obj.position.z;
        const sx = obj.geometry.parameters?.x || 1, sy = obj.geometry.parameters?.y || 1, sz = obj.geometry.parameters?.z || 1;
        if (
          nx > ox - sx/2 && nx < ox + sx/2 &&
          ny > oy - sy/2 && ny < oy + sy/2 &&
          nz > oz - sz/2 && nz < oz + sz/2 ) return true;
      }
      return false;
    }

    function animate() {
      let bonecoAtivo = bonecoSTL || bonecoReserva;

      let nx = bonecoAtivo.position.x, ny = bonecoAtivo.position.y, nz = bonecoAtivo.position.z;
      if (keys["w"]) nz -= speed;
      if (keys["s"]) nz += speed;
      if (keys["a"]) nx -= speed;
      if (keys["d"]) nx += speed;

      nx = Math.max(-8.5, Math.min(8.5, nx));
      nz = Math.max(-8.5, Math.min(8.5, nz));
      ny = Math.max(0.25, Math.min(4.6, ny));

      if (!colisao(nx, ny, nz)) {
        bonecoAtivo.position.x = nx; bonecoAtivo.position.z = nz; bonecoAtivo.position.y = ny;
      }
      camera.position.x = bonecoAtivo.position.x;
      camera.position.z = bonecoAtivo.position.z + 12;
      camera.position.y = 6 + bonecoAtivo.position.y/1.7;

      prateleiraPerto = null;
      for (const shelf of prateleiras) {
        const dist = Math.sqrt(
          Math.pow(bonecoAtivo.position.x - shelf.position.x,2) +
          Math.pow(bonecoAtivo.position.y - shelf.position.y,2) +
          Math.pow(bonecoAtivo.position.z - shelf.position.z,2));
        if (dist < 2.4) { prateleiraPerto = shelf; break; }
      }

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    document.addEventListener("keydown", function(e) {
      if (e.key.toLowerCase() === "o" && prateleiraPerto) {
        mostrarInfo(prateleiraPerto.userData.label);
      }
    });

    function mostrarInfo(texto) {
      const div = document.getElementById("info");
      div.innerHTML = texto + '<br><span style="font-size:0.8em;color:#222;">(Mexe-te com WASD para explorar!)</span>';
      setTimeout(() => {
        div.innerHTML = 'Usa WASD para mover o boneco. Aproxima-te das prateleiras e pressiona <b>O</b> para ver info.';
      }, 4000);
    }
  </script>
</body>
</html>
