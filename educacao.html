<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Biblioteca 3D - Inclinação recorte perfeito</title>
  <style>
    html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; }
    #info { position: absolute; top: 12px; left: 12px;
      background: rgba(255,255,255,0.92); padding: 10px 18px; border-radius: 8px;
      font-family: 'Segoe UI', sans-serif; font-size: 1.1rem; color: #0066bb; z-index: 4; }
    #hud { position: fixed; left: 24px; bottom: 24px;
      background: rgba(240,247,255,0.95); padding: 13px 22px 11px 18px;
      border-radius: 14px; font-family: 'Segoe UI'; color: #083c6a;
      min-width: 210px; font-size: 1.1rem; z-index: 10;
      border: 2px solid #a5c7e6;}
    #hud .title { font-weight: bold; font-size: 1.05rem; margin-bottom: 8px; }
    #hud .keys { margin-top: 0; margin-bottom: 0; }
    #hud .key { background: #dbeafe; border-radius: 5px; padding: 3px 8px;
      margin: 0 4px; border: 1px solid #a5c7e6; font-weight: 500;
      display: inline-block; font-size: 1.0rem; color: #2a68b2; }
    #hud .desc { margin-top: 10px; font-size: 0.97rem; color: #1e3d59; }
  </style>
</head>
<body>
  <div id="info">Usa WASD para mover o boneco. Aproxima-te das prateleiras e pressiona <b>O</b> para ver info.</div>
  <div id="hud">
    <div class="title">Comandos:</div>
    <div class="keys">
      <span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span>
      <span class="desc">Mover personagem</span>
    </div>
    <div class="keys" style="margin-top:7px;">
      <span class="key">O</span>
      <span class="desc">Abrir informação próxima</span>
    </div>
  </div>
  <script src="https://unpkg.com/three@0.153.0/build/three.min.js"></script>
  <script>
    // Variáveis globais do cenário e câmara
    let larguraSala, alturaSala, profundidadeSala;
    let camera, scene, renderer;
    let boneco, chao;
    let prateleiras = [];
    let objetosSolidos = [];
    let keys = {};

    function criaCena() {
      // Dimensões dependentes do ecrã
      alturaSala = 9.5;
      const aspect = window.innerWidth / window.innerHeight;
      larguraSala = alturaSala * aspect;
      profundidadeSala = alturaSala;

      document.body.innerHTML =
        `<div id="info">Usa WASD para mover o boneco. Aproxima-te das prateleiras e pressiona <b>O</b> para ver info.</div>
        <div id="hud">
          <div class="title">Comandos:</div>
          <div class="keys"><span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span>
          <span class="desc">Mover personagem</span></div>
          <div class="keys" style="margin-top:7px;"><span class="key">O</span>
          <span class="desc">Abrir informação próxima</span></div></div>`;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xe8e3d1);

      // Perspectiva: inclinação à la "isométrico", bem recortado
      camera = new THREE.PerspectiveCamera(70, aspect, 0.1, 1000);
      camera.position.set(0, alturaSala * 0.85, larguraSala * 0.65);
      camera.lookAt(0, alturaSala * 0.36, -profundidadeSala * 0.23);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      scene.add(new THREE.AmbientLight(0xfad7a0, 0.7));
      const dirLight = new THREE.DirectionalLight(0xffe1b7, 0.85);
      dirLight.position.set(12, alturaSala, 18); scene.add(dirLight);

      // Chão justo ao ecrã
      const chaoGeo = new THREE.BoxGeometry(larguraSala, 0.25, profundidadeSala);
      const chaoMat = new THREE.MeshLambertMaterial({ color: 0xc9ad7c });
      chao = new THREE.Mesh(chaoGeo, chaoMat);
      chao.position.y = -0.17; chao.userData.solido = true; scene.add(chao);

      // Estante traseira central
      criaEstanteTraseiraLivros(0, -profundidadeSala / 2 + 0.37, larguraSala - 2.2, alturaSala - 4.2, 0.65);

      // Estantes laterais (recorte à sala visível)
      criaEstanteLateralLivros(-larguraSala / 2 + 0.36, 0.65, alturaSala - 4.2, profundidadeSala - 2.2, 'esquerda');
      criaEstanteLateralLivros(larguraSala / 2 - 0.36, 0.65, alturaSala - 4.2, profundidadeSala - 2.2, 'direita');

      // Prateleiras educativas/interativas (blocos amarelos)
      prateleiras = [];
      prateleiras.push(criaPrat(-2, -3, 1.3, "Licenciatura em Engenharia Biomédica<br><i>IPS/ISEL (2023- )</i><br>Projetos IA Médica, tese segmentação de tumores."));
      prateleiras.push(criaPrat(2, -3, 1.3, "Ensino Secundário<br><i>Escola Secundária de Setúbal (2019-2022)</i><br>Distinção, competição natação."));
      prateleiras.push(criaPrat(0, 0, 1.3, "Side Quests & Clubes<br><i>Clubes científicos, voluntariado, projetos extracurriculares.</i>"));

      // Boneco centrado
      boneco = criaBoneco();
      scene.add(boneco);

      atualizaColisoes();
    }

    function criaEstanteTraseiraLivros(x, z, largura, altura, profundidade, cor = 0x7a4a21) {
      const estGeo = new THREE.BoxGeometry(largura, altura, profundidade);
      const estMat = new THREE.MeshLambertMaterial({ color: cor });
      const estante = new THREE.Mesh(estGeo, estMat);
      estante.position.set(x, altura / 2 + 0.03, z);
      estante.userData.solido = true;
      scene.add(estante);

      const nFilas = 3, livrosPorFila = Math.floor(largura / 0.65);
      const livroWidth = largura / livrosPorFila;
      const profundidadeLivros = profundidade / 2 + 0.12;
      for (let f = 0; f < nFilas; f++) {
        let py = 0.54 + f * ((altura - 0.9) / (nFilas - 1));
        for (let l = 0; l < livrosPorFila; l++) {
          let lx = x - largura / 2 + (l + 0.5) * livroWidth;
          const livroGeo = new THREE.BoxGeometry(livroWidth - 0.08, 0.43 + Math.random() * 0.11, 0.15);
          const livroMat = new THREE.MeshLambertMaterial({
            color: Math.random() > 0.3 ? Math.floor(Math.random() * 0xffffff) : 0xdacaa7
          });
          const livro = new THREE.Mesh(livroGeo, livroMat);
          livro.position.set(lx, py, z + profundidadeLivros);
          scene.add(livro);
        }
      }
    }

    function criaEstanteLateralLivros(x, largura, altura, profundidade, lado = 'esquerda', cor = 0x7a4a21) {
      const estGeo = new THREE.BoxGeometry(largura, altura, profundidade);
      const estMat = new THREE.MeshLambertMaterial({ color: cor });
      const estante = new THREE.Mesh(estGeo, estMat);
      estante.position.set(x, altura / 2 + 0.03, 0);
      estante.userData.solido = true;
      scene.add(estante);

      const nFilas = 3, livrosPorFila = Math.floor(profundidade / 0.65);
      const livroWidth = profundidade / livrosPorFila;
      for (let f = 0; f < nFilas; f++) {
        let py = 0.54 + f * ((altura - 0.9) / (nFilas - 1));
        for (let l = 0; l < livrosPorFila; l++) {
          let lz = -profundidade / 2 + (l + 0.5) * livroWidth;
          const livroGeo = new THREE.BoxGeometry(0.15, 0.43 + Math.random() * 0.11, livroWidth - 0.08);
          const livroMat = new THREE.MeshLambertMaterial({
            color: Math.random() > 0.3 ? Math.floor(Math.random() * 0xffffff) : 0xdacaa7
          });
          let lx = x + (lado === 'esquerda' ? (largura / 2 + 0.058) : -(largura / 2 + 0.058));
          if (lado === 'direita') lx = x - (largura / 2 + 0.058);
          const livro = new THREE.Mesh(livroGeo, livroMat);
          livro.position.set(lx, py, lz);
          scene.add(livro);
        }
      }
    }

    function criaPrat(x, z, y, texto) {
      const geo = new THREE.BoxGeometry(2.1, 2.1, 0.65);
      const mat = new THREE.MeshLambertMaterial({ color: 0xffc107 });
      const shelf = new THREE.Mesh(geo, mat);
      shelf.position.set(x, y, z);
      shelf.userData.label = texto;
      shelf.userData.interacao = true;
      shelf.userData.solido = true;
      scene.add(shelf);
      return shelf;
    }

    function criaBoneco() {
      const grupo = new THREE.Group();
      const corpoGeo = new THREE.BoxGeometry(1, 1.6, 0.7);
      const corpoMat = new THREE.MeshLambertMaterial({ color: 0x2196f3 });
      const corpo = new THREE.Mesh(corpoGeo, corpoMat); corpo.position.y = 1;
      grupo.add(corpo);
      const cabecaGeo = new THREE.BoxGeometry(0.8, 0.7, 0.7);
      const cabecaMat = new THREE.MeshLambertMaterial({ color: 0xfff176 });
      const cabeca = new THREE.Mesh(cabecaGeo, cabecaMat); cabeca.position.y = 2;
      grupo.add(cabeca);
      grupo.position.set(0, 0.25, 2.5);
      return grupo;
    }

    // COLISÕES E CONTROLOS
    function atualizaColisoes() {
      objetosSolidos.length = 0;
      scene.traverse(obj => { if (obj.userData && obj.userData.solido) objetosSolidos.push(obj); });
    }

    function colisao(nx, ny, nz) {
      for (const obj of objetosSolidos) {
        const ox = obj.position.x, oy = obj.position.y, oz = obj.position.z;
        const sx = obj.geometry.parameters.x || 1, sy = obj.geometry.parameters.y || 1, sz = obj.geometry.parameters.z || 1;
        if (
          nx > ox - sx / 2 && nx < ox + sx / 2 &&
          ny > oy - sy / 2 && ny < oy + sy / 2 &&
          nz > oz - sz / 2 && nz < oz + sz / 2 ) return true;
      }
      return false;
    }

    let prateleiraPerto = null;
    const speed = 0.13;
    function animate() {
      let nx = boneco.position.x, ny = boneco.position.y, nz = boneco.position.z;
      if (keys["w"]) nz -= speed;
      if (keys["s"]) nz += speed;
      if (keys["a"]) nx -= speed;
      if (keys["d"]) nx += speed;
      nx = Math.max(-larguraSala / 2 + 1, Math.min(larguraSala / 2 - 1, nx));
      nz = Math.max(-profundidadeSala / 2 + 1, Math.min(profundidadeSala / 2 - 1, nz));
      ny = Math.max(0.25, Math.min(alturaSala - 1, ny));
      if (!colisao(nx, ny, nz)) {
        boneco.position.x = nx; boneco.position.z = nz; boneco.position.y = ny;
      }
      prateleiraPerto = null;
      for (const shelf of prateleiras) {
        const dist = Math.sqrt(
          Math.pow(boneco.position.x - shelf.position.x, 2) +
          Math.pow(boneco.position.y - shelf.position.y, 2) +
          Math.pow(boneco.position.z - shelf.position.z, 2));
        if (dist < 2.4) { prateleiraPerto = shelf; break; }
      }
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    // CONTROLOS E INIT
    document.addEventListener("keydown", e => { keys[e.key.toLowerCase()] = true; });
    document.addEventListener("keyup", e => { keys[e.key.toLowerCase()] = false; });
    document.addEventListener("keydown", function (e) {
      if (e.key.toLowerCase() === "o" && prateleiraPerto) {
        mostrarInfo(prateleiraPerto.userData.label);
      }
    });
    function mostrarInfo(texto) {
      const div = document.getElementById("info");
      div.innerHTML = texto +
        '<br><span style="font-size:0.8em;color:#222;">(Mexe-te com WASD para explorar!)</span>';
      setTimeout(() => {
        div.innerHTML = 'Usa WASD para mover o boneco. Aproxima-te das prateleiras e pressiona <b>O</b> para ver info.';
      }, 4000);
    }

    // Dinamismo ao redimensionar
    window.addEventListener('resize', () => {
      criaCena();
      atualizaColisoes();
    });

    // START
    criaCena();
    animate();
  </script>
</body>
</html>
